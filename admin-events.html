<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Manage Events - Admin</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
    }

    .container {
      max-width: 1400px;
      margin: 0 auto;
    }

    /* Navigation Bar */
    .navbar {
      background: white;
      padding: 15px 25px;
      border-radius: 15px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.1);
      margin-bottom: 30px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      gap: 15px;
    }

    .nav-left {
      display: flex;
      align-items: center;
      gap: 20px;
    }

    .nav-title {
      font-size: 20px;
      color: #333;
      font-weight: 600;
    }

    .nav-links {
      display: flex;
      gap: 15px;
    }

    .nav-link {
      padding: 8px 16px;
      border-radius: 8px;
      text-decoration: none;
      color: #666;
      font-size: 14px;
      font-weight: 500;
      transition: all 0.3s;
      border: 2px solid transparent;
    }

    .nav-link:hover {
      background: #f5f5f5;
      color: #667eea;
    }

    .nav-link.active {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
    }

    .nav-right {
      display: flex;
      align-items: center;
      gap: 15px;
    }

    .user-info {
      font-size: 14px;
      color: #666;
    }

    .btn {
      padding: 10px 20px;
      border-radius: 8px;
      border: none;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
      font-family: inherit;
      text-decoration: none;
      display: inline-flex;
      align-items: center;
      gap: 8px;
    }

    .btn-logout {
      background: #fee;
      color: #c33;
      border: 2px solid #fcc;
    }

    .btn-logout:hover {
      background: #fcc;
      transform: translateY(-2px);
    }

    .btn-primary {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      width: 100%;
    }

    .btn-primary:hover:not(:disabled) {
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
    }

    .btn-primary:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      transform: none;
    }

    .btn-success {
      background: #28a745;
      color: white;
    }

    .btn-success:hover {
      background: #218838;
    }

    .btn-warning {
      background: #ffc107;
      color: #333;
    }

    .btn-warning:hover {
      background: #e0a800;
    }

    .btn-danger {
      background: #dc3545;
      color: white;
    }

    .btn-danger:hover {
      background: #c82333;
    }

    .btn-ghost {
      background: transparent;
      border: 2px solid #ddd;
      color: #666;
    }

    .btn-ghost:hover {
      border-color: #667eea;
      color: #667eea;
    }

    /* Stats Cards */
    .stats {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }

    .stat-card {
      background: white;
      padding: 25px;
      border-radius: 15px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.1);
      text-align: center;
    }

    .stat-value {
      font-size: 36px;
      font-weight: bold;
      color: #667eea;
      margin-bottom: 5px;
    }

    .stat-label {
      color: #666;
      font-size: 14px;
    }

    /* Control Bar */
    .control-bar {
      background: white;
      padding: 25px;
      border-radius: 15px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.1);
      margin-bottom: 30px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      gap: 20px;
    }

    /* Form Elements */
    .form-group {
      margin-bottom: 20px;
    }

    label {
      display: block;
      margin-bottom: 8px;
      color: #555;
      font-weight: 600;
      font-size: 14px;
    }

    input[type="text"],
    input[type="date"],
    select,
    textarea {
      width: 100%;
      padding: 12px;
      border: 2px solid #ddd;
      border-radius: 8px;
      font-size: 14px;
      transition: border-color 0.3s;
      font-family: inherit;
    }

    input:focus,
    select:focus,
    textarea:focus {
      outline: none;
      border-color: #667eea;
    }

    textarea {
      min-height: 100px;
      resize: vertical;
    }

    select {
      cursor: pointer;
    }

    /* Add Form Section */
    .add-section {
      background: white;
      padding: 30px;
      border-radius: 15px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.1);
      margin-bottom: 30px;
      display: none;
    }

    .add-section.active {
      display: block;
    }

    .add-section h2 {
      color: #333;
      margin-bottom: 25px;
      font-size: 22px;
    }

    .form-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
    }

    .file-preview {
      margin-top: 10px;
      max-width: 200px;
      border-radius: 8px;
      display: none;
    }

    .file-preview.active {
      display: block;
    }

    .file-preview img {
      width: 100%;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }

    /* Events Grid */
    .events-section {
      background: white;
      padding: 30px;
      border-radius: 15px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.1);
    }

    .events-section h2 {
      color: #333;
      margin-bottom: 25px;
      font-size: 22px;
    }

    .events-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
      gap: 25px;
    }

    .event-item {
      background: #f8f9fa;
      border-radius: 12px;
      overflow: hidden;
      border: 2px solid #e9ecef;
      transition: all 0.3s;
    }

    .event-item:hover {
      border-color: #667eea;
      box-shadow: 0 5px 20px rgba(102, 126, 234, 0.2);
    }

    .event-item img {
      width: 100%;
      height: 200px;
      object-fit: cover;
    }

    .event-item-body {
      padding: 20px;
    }

    .event-item h3 {
      color: #333;
      font-size: 18px;
      margin-bottom: 10px;
    }

    .event-item-meta {
      display: flex;
      flex-direction: column;
      gap: 8px;
      margin-bottom: 15px;
      font-size: 13px;
      color: #666;
    }

    .meta-tag {
      padding: 4px 12px;
      background: #e9ecef;
      border-radius: 15px;
      font-size: 12px;
      color: #666;
      display: inline-block;
    }

    .event-item-actions {
      display: flex;
      gap: 10px;
    }

    .event-item-actions .btn {
      flex: 1;
      padding: 8px 16px;
      font-size: 13px;
    }

    .message {
      padding: 12px 20px;
      border-radius: 8px;
      margin-bottom: 20px;
      display: none;
      font-size: 14px;
    }

    .message.success {
      background: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
    }

    .message.error {
      background: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
    }

    .loading {
      text-align: center;
      padding: 40px;
      color: #666;
    }

    .no-events {
      text-align: center;
      padding: 60px;
      color: #999;
    }

    @media (max-width: 768px) {
      .form-row {
        grid-template-columns: 1fr;
      }

      .events-grid {
        grid-template-columns: 1fr;
      }

      .control-bar {
        flex-direction: column;
      }

      .nav-links {
        width: 100%;
        justify-content: center;
      }

      .navbar {
        flex-direction: column;
      }

      .stats {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- Navigation Bar -->
    <nav class="navbar">
      <div class="nav-left">
        <div class="nav-title">üéâ Manage Events</div>
        <div class="nav-links">
          <a href="/admin-dashboard.html" class="nav-link">üè† Dashboard</a>
          <a href="/admin-submissions.html" class="nav-link">üìù Submissions</a>
          <a href="/admin-manage.html" class="nav-link">üèõÔ∏è Attractions</a>
          <a href="/admin-events.html" class="nav-link active">üéâ Events</a>
        </div>
      </div>
      <div class="nav-right">
        <span class="user-info">üë§ <span id="userEmail">Loading...</span></span>
        <button class="btn btn-logout" id="logoutBtn">Logout</button>
      </div>
    </nav>

    <!-- Stats -->
    <div class="stats">
      <div class="stat-card">
        <div class="stat-value" id="totalCount">0</div>
        <div class="stat-label">Total Events</div>
      </div>
      <div class="stat-card">
        <div class="stat-value" id="upcomingCount">0</div>
        <div class="stat-label">Upcoming</div>
      </div>
      <div class="stat-card">
        <div class="stat-value" id="happeningCount">0</div>
        <div class="stat-label">Happening Now</div>
      </div>
      <div class="stat-card">
        <div class="stat-value" id="pastCount">0</div>
        <div class="stat-label">Past Events</div>
      </div>
    </div>

    <div id="message" class="message"></div>

    <!-- Control Bar -->
    <div class="control-bar">
      <h2 style="color: #333; margin: 0;">All Events</h2>
      <button class="btn btn-success" id="toggleAddBtn">+ Add New Event</button>
    </div>

    <!-- Add/Edit Form Section -->
    <div class="add-section" id="addSection">
      <h2 id="formTitle">Add New Event</h2>
      <form id="eventForm">
        <input type="hidden" id="editId" value="">
        
        <div class="form-row">
          <div class="form-group">
            <label for="eventName">Event Name *</label>
            <input type="text" id="eventName" required placeholder="e.g., Navratri Festival 2025">
          </div>

          <div class="form-group">
            <label for="eventCategory">Category *</label>
            <select id="eventCategory" required>
              <option value="">Select category</option>
              <option value="Festival">Festival</option>
              <option value="Cultural">Cultural</option>
              <option value="Concert">Concert</option>
              <option value="Religious">Religious</option>
              <option value="Sports">Sports</option>
              <option value="Exhibition">Exhibition</option>
              <option value="Other">Other</option>
            </select>
          </div>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label for="eventState">State *</label>
            <select id="eventState" required>
              <option value="">Select state</option>
              <option value="Gujarat">Gujarat</option>
              <option value="Rajasthan">Rajasthan</option>
              <option value="Assam">Assam</option>
              <option value="Jammu and Kashmir">Jammu and Kashmir</option>
              <option value="Kerala">Kerala</option>
            </select>
          </div>

          <div class="form-group">
            <label for="eventLocation">Location (City/Venue) *</label>
            <input type="text" id="eventLocation" required placeholder="e.g., Ahmedabad">
          </div>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label for="eventStartDate">Start Date *</label>
            <input type="date" id="eventStartDate" required>
          </div>

          <div class="form-group">
            <label for="eventEndDate">End Date *</label>
            <input type="date" id="eventEndDate" required>
          </div>
        </div>

        <div class="form-group">
          <label for="eventDescription">Description *</label>
          <textarea id="eventDescription" required placeholder="Describe the event in detail..." rows="5"></textarea>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label for="eventFee">Entry Fee</label>
            <input type="text" id="eventFee" placeholder="e.g., Free or ‚Çπ500">
          </div>

          <div class="form-group">
            <label for="eventImage">Upload Event Poster/Image</label>
            <input type="file" id="eventImage" accept="image/*">
            <div class="file-preview" id="imagePreview">
              <img id="previewImg" src="" alt="Preview">
            </div>
          </div>
        </div>

        <div class="form-group">
          <label for="eventContacts">Contact Information</label>
          <textarea id="eventContacts" placeholder="Organizer: Name - Phone: +91-XXXXX&#10;Booking: website.com" rows="3"></textarea>
        </div>

        <div style="display: flex; gap: 15px;">
          <button type="submit" class="btn btn-primary" id="submitBtn" style="flex: 1;">
            Save Event
          </button>
          <button type="button" class="btn btn-ghost" id="cancelBtn" style="width: auto;">
            Cancel
          </button>
        </div>
      </form>
    </div>

    <!-- Events List -->
    <div class="events-section">
      <h2>All Events</h2>
      <div id="loadingState" class="loading">Loading events...</div>
      <div id="noEventsState" class="no-events" style="display: none;">
        No events found. Click "Add New Event" to create one.
      </div>
      <div class="events-grid" id="eventsGrid"></div>
    </div>
  </div>

  <script type="module">
    import { requireAuth, logout, supabase } from './js/auth-helper.js';

    const message = document.getElementById('message');
    const userEmailEl = document.getElementById('userEmail');
    const logoutBtn = document.getElementById('logoutBtn');

    const toggleAddBtn = document.getElementById('toggleAddBtn');
    const addSection = document.getElementById('addSection');
    const eventForm = document.getElementById('eventForm');
    const cancelBtn = document.getElementById('cancelBtn');
    const submitBtn = document.getElementById('submitBtn');
    const formTitle = document.getElementById('formTitle');

    const loadingState = document.getElementById('loadingState');
    const noEventsState = document.getElementById('noEventsState');
    const eventsGrid = document.getElementById('eventsGrid');

    const eventImage = document.getElementById('eventImage');
    const imagePreview = document.getElementById('imagePreview');
    const previewImg = document.getElementById('previewImg');

    const totalCountEl = document.getElementById('totalCount');
    const upcomingCountEl = document.getElementById('upcomingCount');
    const happeningCountEl = document.getElementById('happeningCount');
    const pastCountEl = document.getElementById('pastCount');

    let isEditing = false;
    let editingId = null;

    // Show message
    function showMessage(text, type) {
      message.textContent = text;
      message.className = `message ${type}`;
      message.style.display = 'block';
      
      setTimeout(() => {
        message.style.display = 'none';
      }, 5000);
    }

    // Initialize
    async function init() {
      const user = await requireAuth();
      
      if (!user) {
        return;
      }

      userEmailEl.textContent = user.email;
      loadEvents();
    }

    // Toggle add form
    toggleAddBtn.addEventListener('click', () => {
      isEditing = false;
      editingId = null;
      formTitle.textContent = 'Add New Event';
      eventForm.reset();
      document.getElementById('editId').value = '';
      imagePreview.classList.remove('active');
      addSection.classList.toggle('active');
    });

    // Cancel form
    cancelBtn.addEventListener('click', () => {
      addSection.classList.remove('active');
      eventForm.reset();
      isEditing = false;
      editingId = null;
    });

    // Image preview
    eventImage.addEventListener('change', () => {
      const file = eventImage.files[0];
      if (file) {
        const reader = new FileReader();
        reader.onload = (e) => {
          previewImg.src = e.target.result;
          imagePreview.classList.add('active');
        };
        reader.readAsDataURL(file);
      } else {
        imagePreview.classList.remove('active');
      }
    });

    // Submit form
    eventForm.addEventListener('submit', async (e) => {
      e.preventDefault();

      submitBtn.disabled = true;
      submitBtn.textContent = isEditing ? 'Updating...' : 'Saving...';

      const name = document.getElementById('eventName').value.trim();
      const category = document.getElementById('eventCategory').value;
      const state = document.getElementById('eventState').value;
      const location = document.getElementById('eventLocation').value.trim();
      const startDate = document.getElementById('eventStartDate').value;
      const endDate = document.getElementById('eventEndDate').value;
      const description = document.getElementById('eventDescription').value.trim();
      const entryFee = document.getElementById('eventFee').value.trim();
      const contacts = document.getElementById('eventContacts').value.trim();

      // Validate dates
      if (new Date(endDate) < new Date(startDate)) {
        showMessage('End date cannot be before start date', 'error');
        submitBtn.disabled = false;
        submitBtn.textContent = isEditing ? 'Update Event' : 'Save Event';
        return;
      }

      let imageUrl = null;
      let oldImageUrl = null;

      if (isEditing && editingId) {
        const { data: existingData } = await supabase
          .from('events')
          .select('image_url')
          .eq('id', editingId)
          .single();
        
        oldImageUrl = existingData?.image_url;
      }

      if (eventImage.files.length > 0) {
        const file = eventImage.files[0];
        const filePath = `events/${Date.now()}-${file.name.replace(/\s+/g, '')}`;

        const { error: uploadError } = await supabase
          .storage
          .from('bharatyatra-images')
          .upload(filePath, file);

        if (uploadError) {
          showMessage('Image upload failed: ' + uploadError.message, 'error');
          submitBtn.disabled = false;
          submitBtn.textContent = isEditing ? 'Update Event' : 'Save Event';
          return;
        }

        imageUrl = supabase
          .storage
          .from('bharatyatra-images')
          .getPublicUrl(filePath).data.publicUrl;

        if (oldImageUrl && isEditing) {
          const urlParts = oldImageUrl.split('/');
          const oldFilePath = urlParts.slice(-2).join('/');
          await supabase.storage.from('bharatyatra-images').remove([oldFilePath]);
        }
      }

      const eventData = {
        name,
        category,
        state,
        location,
        start_date: startDate,
        end_date: endDate,
        description,
        entry_fee: entryFee || null,
        contact_info: contacts || null,
      };

      if (imageUrl) {
        eventData.image_url = imageUrl;
      } else if (oldImageUrl && isEditing) {
        eventData.image_url = oldImageUrl;
      }

      let result;
      if (isEditing && editingId) {
        result = await supabase
          .from('events')
          .update(eventData)
          .eq('id', editingId);
      } else {
        result = await supabase
          .from('events')
          .insert([eventData]);
      }

      if (result.error) {
        showMessage('Error: ' + result.error.message, 'error');
      } else {
        showMessage(isEditing ? 'Event updated!' : 'Event added!', 'success');
        eventForm.reset();
        imagePreview.classList.remove('active');
        addSection.classList.remove('active');
        loadEvents();
        isEditing = false;
        editingId = null;
      }

      submitBtn.disabled = false;
      submitBtn.textContent = 'Save Event';
    });

    // Load events
    async function loadEvents() {
      loadingState.style.display = 'block';
      eventsGrid.innerHTML = '';
      noEventsState.style.display = 'none';

      const { data, error } = await supabase
        .from('events')
        .select('*')
        .order('start_date', { ascending: true });

      loadingState.style.display = 'none';

      if (error) {
        showMessage('Error loading: ' + error.message, 'error');
        return;
      }

      if (!data || data.length === 0) {
        noEventsState.style.display = 'block';
        updateStats(0, 0, 0, 0);
        return;
      }

      // Calculate stats
      const today = new Date();
      today.setHours(0, 0, 0, 0);
      
      let upcoming = 0, happening = 0, past = 0;
      
      data.forEach(event => {
        const start = new Date(event.start_date);
        const end = new Date(event.end_date);
        
        if (today >= start && today <= end) {
          happening++;
        } else if (today < start) {
          upcoming++;
        } else {
          past++;
        }
      });

      updateStats(data.length, upcoming, happening, past);

      data.forEach(event => {
        const card = createEventCard(event);
        eventsGrid.appendChild(card);
      });
    }

    // Update stats
    function updateStats(total, upcoming, happening, past) {
      totalCountEl.textContent = total;
      upcomingCountEl.textContent = upcoming;
      happeningCountEl.textContent = happening;
      pastCountEl.textContent = past;
    }

    // Format date
    function formatDate(date) {
      return new Date(date).toLocaleDateString('en-US', {
        month: 'short',
        day: 'numeric',
        year: 'numeric'
      });
    }

    // Create event card
    function createEventCard(event) {
      const card = document.createElement('div');
      card.className = 'event-item';

      const imageUrl = event.image_url || 'https://via.placeholder.com/300x200?text=' + encodeURIComponent(event.name);

      card.innerHTML = `
        <img src="${imageUrl}" alt="${event.name}">
        <div class="event-item-body">
          <h3>${event.name}</h3>
          <div class="event-item-meta">
            <div><strong>üìÖ</strong> ${formatDate(event.start_date)} - ${formatDate(event.end_date)}</div>
            <div><strong>üìç</strong> ${event.location}, ${event.state}</div>
            <div><span class="meta-tag">${event.category}</span></div>
          </div>
          <div class="event-item-actions">
            <button class="btn btn-warning btn-edit" data-id="${event.id}">Edit</button>
            <button class="btn btn-danger btn-delete" data-id="${event.id}">Delete</button>
          </div>
        </div>
      `;

      card.querySelector('.btn-edit').addEventListener('click', () => {
        editEvent(event);
      });

      card.querySelector('.btn-delete').addEventListener('click', () => {
        deleteEvent(event);
      });

      return card;
    }

    // Edit event
    function editEvent(event) {
      isEditing = true;
      editingId = event.id;
      formTitle.textContent = 'Edit Event';

      document.getElementById('eventName').value = event.name;
      document.getElementById('eventCategory').value = event.category;
      document.getElementById('eventState').value = event.state;
      document.getElementById('eventLocation').value = event.location;
      document.getElementById('eventStartDate').value = event.start_date;
      document.getElementById('eventEndDate').value = event.end_date;
      document.getElementById('eventDescription').value = event.description;
      document.getElementById('eventFee').value = event.entry_fee || '';
      document.getElementById('eventContacts').value = event.contact_info || '';

      if (event.image_url) {
        previewImg.src = event.image_url;
        imagePreview.classList.add('active');
      }

      addSection.classList.add('active');
      addSection.scrollIntoView({ behavior: 'smooth' });
    }

    // Delete event
    async function deleteEvent(event) {
      if (!confirm(`Delete "${event.name}"? This cannot be undone.`)) {
        return;
      }

      if (event.image_url) {
        const urlParts = event.image_url.split('/');
        const filePath = urlParts.slice(-2).join('/');
        
        await supabase
          .storage
          .from('bharatyatra-images')
          .remove([filePath]);
      }

      const { error } = await supabase
        .from('events')
        .delete()
        .eq('id', event.id);

      if (error) {
        showMessage('Delete failed: ' + error.message, 'error');
        return;
      }

      showMessage('Event deleted successfully', 'success');
      loadEvents();
    }

    // Logout
    logoutBtn.addEventListener('click', async () => {
      if (confirm('Are you sure you want to logout?')) {
        await logout();
      }
    });

    // Initialize
    init();
  </script>
</body>
</html>