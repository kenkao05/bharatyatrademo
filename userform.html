<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Admin Dashboard - Submissions</title>
  <style>
    :root {
      --bg: #F8F4EC;
      --card: #F5EFEB;
      --accent: #B8A992;
      --muted: #8A7D6C;
      font-family: 'Georgia', 'Times New Roman', serif;
    }

    * { box-sizing: border-box; }
    
    body {
      margin: 0;
      background: linear-gradient(180deg, #F8F4EC 0%, #F5EFEB 100%);
      color: #5A4F41;
      padding: 32px;
      min-height: 100vh;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
    }

    h1 {
      font-size: 28px;
      color: #7A6A57;
      margin-bottom: 24px;
    }

    .auth-section {
      background: rgba(248, 244, 236, 0.7);
      border-radius: 14px;
      padding: 28px;
      box-shadow: 0 10px 30px rgba(90, 79, 65, 0.15);
      margin-bottom: 24px;
    }

    .auth-form {
      display: flex;
      gap: 12px;
      align-items: flex-end;
      flex-wrap: wrap;
    }

    .form-group {
      flex: 1;
      min-width: 200px;
    }

    label {
      display: block;
      font-size: 13px;
      margin-bottom: 8px;
      color: var(--muted);
    }

    input {
      width: 100%;
      padding: 12px 14px;
      border-radius: 10px;
      background: rgba(232, 223, 208, 0.5);
      border: 1px solid rgba(212, 199, 178, 0.4);
      color: #5A4F41;
      font-size: 14px;
      outline: none;
      font-family: 'Georgia', 'Times New Roman', serif;
    }

    input:focus {
      box-shadow: 0 6px 18px rgba(184, 169, 146, 0.2);
      border-color: rgba(184, 169, 146, 0.6);
      background: rgba(232, 223, 208, 0.7);
    }

    .btn {
      padding: 12px 20px;
      border-radius: 10px;
      border: 0;
      cursor: pointer;
      font-weight: 600;
      font-size: 14px;
      font-family: 'Georgia', 'Times New Roman', serif;
      transition: all 0.3s ease;
    }

    .btn-primary {
      background: linear-gradient(90deg, #B8A992, #D4C7B2);
      color: #5A4F41;
      box-shadow: 0 2px 8px rgba(184, 169, 146, 0.3);
    }

    .btn-primary:hover {
      background: linear-gradient(90deg, #D4C7B2, #E8DFD0);
      transform: translateY(-1px);
    }

    .btn-danger {
      background: #B8695F;
      color: white;
    }

    .btn-danger:hover {
      background: #A05850;
    }

    .btn-ghost {
      background: transparent;
      border: 1px solid rgba(212, 199, 178, 0.6);
      color: var(--muted);
    }

    .btn-ghost:hover {
      background: rgba(212, 199, 178, 0.3);
    }

    .submissions-grid {
      display: grid;
      gap: 20px;
      grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
    }

    .submission-card {
      background: rgba(248, 244, 236, 0.7);
      border-radius: 14px;
      padding: 20px;
      box-shadow: 0 10px 30px rgba(90, 79, 65, 0.15);
      border: 1px solid rgba(212, 199, 178, 0.3);
    }

    .submission-card img {
      width: 100%;
      height: 200px;
      object-fit: cover;
      border-radius: 10px;
      margin-bottom: 12px;
    }

    .submission-card h3 {
      margin: 0 0 8px 0;
      color: #7A6A57;
      font-size: 18px;
    }

    .submission-meta {
      font-size: 13px;
      color: var(--muted);
      margin-bottom: 12px;
    }

    .submission-description {
      font-size: 14px;
      line-height: 1.6;
      margin-bottom: 16px;
    }

    .submission-actions {
      display: flex;
      gap: 8px;
    }

    .notice {
      padding: 12px;
      border-radius: 10px;
      margin-bottom: 20px;
      font-size: 14px;
    }

    .notice.error {
      background: rgba(184, 105, 95, 0.2);
      color: #B8695F;
      border: 1px solid rgba(184, 105, 95, 0.4);
    }

    .notice.success {
      background: rgba(139, 195, 139, 0.2);
      color: #3d5a3d;
      border: 1px solid rgba(139, 195, 139, 0.4);
    }

    .notice.info {
      background: rgba(184, 169, 146, 0.2);
      color: #7A6A57;
      border: 1px solid rgba(212, 199, 178, 0.4);
    }

    .stats {
      display: flex;
      gap: 16px;
      margin-bottom: 24px;
    }

    .stat-card {
      background: rgba(248, 244, 236, 0.7);
      border-radius: 14px;
      padding: 16px 24px;
      box-shadow: 0 4px 12px rgba(90, 79, 65, 0.1);
      flex: 1;
    }

    .stat-value {
      font-size: 32px;
      font-weight: bold;
      color: #7A6A57;
    }

    .stat-label {
      font-size: 13px;
      color: var(--muted);
    }

    .loading {
      text-align: center;
      padding: 40px;
      color: var(--muted);
    }

    .no-image {
      width: 100%;
      height: 200px;
      border-radius: 10px;
      background: rgba(232, 223, 208, 0.6);
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--muted);
      margin-bottom: 12px;
      font-size: 14px;
    }

    @media (max-width: 768px) {
      .submissions-grid {
        grid-template-columns: 1fr;
      }
      
      .auth-form {
        flex-direction: column;
      }
      
      .form-group {
        width: 100%;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>Admin Dashboard</h1>

    <!-- Authentication Section -->
    <div class="auth-section" id="authSection">
      <div id="loginForm">
        <h2 style="margin-top: 0;">Login</h2>
        <div class="auth-form">
          <div class="form-group">
            <label for="email">Email</label>
            <input type="email" id="email" placeholder="admin@example.com" />
          </div>
          <div class="form-group">
            <label for="password">Password</label>
            <input type="password" id="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" />
          </div>
          <button class="btn btn-primary" id="loginBtn">Login</button>
        </div>
      </div>

      <div id="loggedInSection" style="display: none;">
        <div style="display: flex; justify-content: space-between; align-items: center;">
          <p style="margin: 0;">Logged in as: <strong id="userEmail"></strong></p>
          <button class="btn btn-ghost" id="logoutBtn">Logout</button>
        </div>
      </div>
    </div>

    <div id="message"></div>

    <!-- Stats Section -->
    <div class="stats" id="statsSection" style="display: none;">
      <div class="stat-card">
        <div class="stat-value" id="totalCount">0</div>
        <div class="stat-label">Total Submissions</div>
      </div>
      <div class="stat-card">
        <div class="stat-value" id="stateCount">0</div>
        <div class="stat-label">States Covered</div>
      </div>
    </div>

    <!-- Submissions Section -->
    <div id="submissionsSection" style="display: none;">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
        <h2 style="margin: 0;">Submissions</h2>
        <button class="btn btn-ghost" id="refreshBtn">Refresh</button>
      </div>
      <div class="submissions-grid" id="submissionsGrid"></div>
    </div>

    <div class="loading" id="loading" style="display: none;">Loading...</div>
  </div>

  <script type="module">
    import { supabaseClient } from "/js/supabase.js";

    const loginForm = document.getElementById("loginForm");
    const loggedInSection = document.getElementById("loggedInSection");
    const loginBtn = document.getElementById("loginBtn");
    const logoutBtn = document.getElementById("logoutBtn");
    const emailInput = document.getElementById("email");
    const passwordInput = document.getElementById("password");
    const userEmailEl = document.getElementById("userEmail");
    const message = document.getElementById("message");
    const submissionsSection = document.getElementById("submissionsSection");
    const statsSection = document.getElementById("statsSection");
    const submissionsGrid = document.getElementById("submissionsGrid");
    const loading = document.getElementById("loading");
    const refreshBtn = document.getElementById("refreshBtn");
    const totalCountEl = document.getElementById("totalCount");
    const stateCountEl = document.getElementById("stateCount");

    let currentUser = null;

    // Check if user is already logged in
    async function checkAuth() {
      const { data: { user } } = await supabaseClient.auth.getUser();
      if (user) {
        currentUser = user;
        showLoggedIn();
        loadSubmissions();
      }
    }

    // Login
    loginBtn.addEventListener("click", async () => {
      const email = emailInput.value.trim();
      const password = passwordInput.value.trim();

      if (!email || !password) {
        showMessage("Please enter email and password", "error");
        return;
      }

      loginBtn.disabled = true;
      loginBtn.textContent = "Logging in...";

      const { data, error } = await supabaseClient.auth.signInWithPassword({
        email,
        password
      });

      if (error) {
        showMessage("Login failed: " + error.message, "error");
        loginBtn.disabled = false;
        loginBtn.textContent = "Login";
        return;
      }

      currentUser = data.user;
      showLoggedIn();
      loadSubmissions();
      emailInput.value = "";
      passwordInput.value = "";
      loginBtn.disabled = false;
      loginBtn.textContent = "Login";
    });

    // Logout
    logoutBtn.addEventListener("click", async () => {
      await supabaseClient.auth.signOut();
      currentUser = null;
      loginForm.style.display = "block";
      loggedInSection.style.display = "none";
      submissionsSection.style.display = "none";
      statsSection.style.display = "none";
      showMessage("Logged out successfully", "success");
    });

    // Show logged in state
    function showLoggedIn() {
      loginForm.style.display = "none";
      loggedInSection.style.display = "block";
      submissionsSection.style.display = "block";
      statsSection.style.display = "flex";
      userEmailEl.textContent = currentUser.email;
    }

    // Load submissions
    async function loadSubmissions() {
      loading.style.display = "block";
      submissionsGrid.innerHTML = "";

      const { data, error } = await supabaseClient
        .from("submissions")
        .select("*")
        .order("created_at", { ascending: false });

      loading.style.display = "none";

      if (error) {
        showMessage("Failed to load submissions: " + error.message, "error");
        return;
      }

      if (!data || data.length === 0) {
        submissionsGrid.innerHTML = '<p style="grid-column: 1/-1; text-align: center; color: var(--muted);">No submissions yet</p>';
        return;
      }

      // Update stats
      totalCountEl.textContent = data.length;
      const uniqueStates = new Set(data.map(s => s.state));
      stateCountEl.textContent = uniqueStates.size;

      // Render submissions
      data.forEach(submission => {
        const card = createSubmissionCard(submission);
        submissionsGrid.appendChild(card);
      });
    }

    // Create submission card
    function createSubmissionCard(submission) {
      const card = document.createElement("div");
      card.className = "submission-card";

      const date = new Date(submission.created_at).toLocaleDateString("en-IN", {
        year: "numeric",
        month: "short",
        day: "numeric"
      });

      card.innerHTML = `
        ${submission.image_url 
          ? `<img src="${submission.image_url}" alt="${submission.spot_name}" />`
          : `<div class="no-image">No image</div>`
        }
        <h3>${submission.spot_name}</h3>
        <div class="submission-meta">
          üìç ${submission.district}, ${submission.state}<br>
          üìÖ ${date}
        </div>
        <div class="submission-description">
          ${submission.description}
        </div>
        <div class="submission-actions">
          <button class="btn btn-danger btn-delete" data-id="${submission.id}">Delete</button>
        </div>
      `;

      // Delete button handler
      card.querySelector(".btn-delete").addEventListener("click", async () => {
        if (!confirm(`Delete "${submission.spot_name}"?`)) return;

        const deleteBtn = card.querySelector(".btn-delete");
        deleteBtn.disabled = true;
        deleteBtn.textContent = "Deleting...";

        // Delete image from storage if exists
        if (submission.image_url) {
          const urlParts = submission.image_url.split("/");
          const filePath = urlParts.slice(-2).join("/"); // Get "suggestions/filename"
          
          await supabaseClient
            .storage
            .from("bharatyatra-images")
            .remove([filePath]);
        }

        // Delete submission from database
        const { error } = await supabaseClient
          .from("submissions")
          .delete()
          .eq("id", submission.id);

        if (error) {
          showMessage("Failed to delete: " + error.message, "error");
          deleteBtn.disabled = false;
          deleteBtn.textContent = "Delete";
          return;
        }

        card.remove();
        showMessage("Submission deleted successfully", "success");
        loadSubmissions(); // Reload to update stats
      });

      return card;
    }

    // Show message
    function showMessage(text, type) {
      message.className = `notice ${type}`;
      message.textContent = text;
      message.style.display = "block";
      setTimeout(() => {
        message.style.display = "none";
      }, 5000);
    }

    // Refresh button
    refreshBtn.addEventListener("click", loadSubmissions);

    // Initialize
    checkAuth();

    // Add this debugging section after checkAuth function
    async function debugAuth() {
      const { data: { session } } = await supabaseClient.auth.getSession();
      console.log("Session:", session);
      console.log("User:", session?.user);
      console.log("Access token:", session?.access_token ? "Present" : "Missing");
    }

    // Call it when checking auth
    async function checkAuth() {
      const { data: { user } } = await supabaseClient.auth.getUser();
      console.log("Current user:", user); // Debug log
      if (user) {
        currentUser = user;
        showLoggedIn();
        await debugAuth(); // Debug auth
        loadSubmissions();
      }
    }

  </script>
</body>
</html>